name: Build & Release SoCute

on:
  push:
    tags:
      - "v*" 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.19.0'

      - name: Generate Project & Install Dependencies
        run: |
          flutter create . --project-name socute --org com.socute
          flutter config --no-analytics
          
          # 1. Install Dependencies
          # We use 'flutter pub add' to inject packages into pubspec.yaml
          flutter pub add dio archive path_provider device_info_plus device_apps file_picker flutter_launcher_icons http shared_preferences code_text_field flutter_highlight
          
          # 2. Force Upgrade
          # Crucial: This resolves conflicts with older packages (like device_apps)
          # by pulling the latest compatible transitive dependencies.
          flutter pub upgrade

      # --- GENERATE ICON ---
      - name: Generate App Icon
        run: |
          python3 -c "
          import os
          import subprocess
          
          if os.path.exists('icon.png'):
              print('Custom icon found!')
              config = \"\"\"
          flutter_icons:
            android: 'ic_launcher'
            ios: true
            image_path: 'icon.png'
            min_sdk_android: 21
          \"\"\"
              with open('flutter_launcher_icons.yaml', 'w') as f:
                  f.write(config.strip())
              subprocess.run(['flutter', 'pub', 'run', 'flutter_launcher_icons'], check=True)
          "

      # --- MANIFEST UPDATE (With Storage Permission) ---
      - name: Update AndroidManifest.xml
        run: |
          python3 -c "
          import os
          
          manifest_path = 'android/app/src/main/AndroidManifest.xml'
          if os.path.exists(manifest_path):
              os.remove(manifest_path)
          
          manifest_content = \"\"\"<manifest xmlns:android='http://schemas.android.com/apk/res/android' package='com.socute.socute'>
              <uses-permission android:name='android.permission.INTERNET'/>
              <uses-permission android:name='android.permission.QUERY_ALL_PACKAGES'/>
              <uses-permission android:name='android.permission.READ_EXTERNAL_STORAGE'/> 
              
              <application
                  android:label='SoCute'
                  android:name='\${applicationName}'
                  android:icon='@mipmap/ic_launcher'
                  android:requestLegacyExternalStorage='true'>
                  <activity
                      android:name='.MainActivity'
                      android:exported='true'
                      android:launchMode='singleTop'
                      android:theme='@style/LaunchTheme'
                      android:configChanges='orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode'
                      android:hardwareAccelerated='true'
                      android:windowSoftInputMode='adjustResize'>
                      <meta-data android:name='io.flutter.embedding.android.NormalTheme' android:resource='@style/NormalTheme'/>
                      <intent-filter>
                          <action android:name='android.intent.action.MAIN'/>
                          <category android:name='android.intent.category.LAUNCHER'/>
                      </intent-filter>
                  </activity>
                  <meta-data android:name='flutterEmbedding' android:value='2' />
              </application>
          </manifest>\"\"\"
          
          with open(manifest_path, 'w') as f:
              f.write(manifest_content)
          print('‚úÖ AndroidManifest.xml Updated')
          "

      - name: Install Dart Dependencies
        run: flutter pub get

      # --- CRITICAL FIX FOR 403 FORBIDDEN (DOUBLE PATCH) ---
      # This step forces Aliyun Mirrors into both build.gradle AND settings.gradle
      # to prevent Maven Central blocking on CI runners.
      - name: Patch Gradle Repositories (Aliyun Mirror)
        run: |
          python3 -c "
          import os

          def patch_file(path):
              if not os.path.exists(path):
                  print(f'‚ö†Ô∏è  Skipping {path} (File not found)')
                  return

              print(f'üîß Patching {path}...')
              with open(path, 'r') as f: content = f.read()

              # Define Aliyun Mirrors
              aliyun_google = 'maven { url \"https://maven.aliyun.com/repository/google\" }'
              aliyun_public = 'maven { url \"https://maven.aliyun.com/repository/public\" }'
              aliyun_plugins = 'maven { url \"https://maven.aliyun.com/repository/gradle-plugin\" }'

              # Inject Mirrors BEFORE the standard repos
              # 1. Google
              if 'google()' in content and 'maven.aliyun.com' not in content:
                  content = content.replace('google()', f'{aliyun_google}\n        google()')
              
              # 2. Maven Central
              if 'mavenCentral()' in content:
                  content = content.replace('mavenCentral()', f'{aliyun_public}\n        mavenCentral()')
              
              # 3. Gradle Plugin Portal (Common in settings.gradle)
              if 'gradlePluginPortal()' in content:
                   content = content.replace('gradlePluginPortal()', f'{aliyun_plugins}\n        gradlePluginPortal()')

              with open(path, 'w') as f: f.write(content)
              print(f'‚úÖ Successfully patched {path}')

          # Apply patch to both possible configuration files
          patch_file('android/build.gradle')
          patch_file('android/settings.gradle')
          "

      - name: Build Release APK
        run: flutter build apk --release --no-tree-shake-icons

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/socute-${{ github.ref_name }}.apk

      - name: Create Release & Upload APK
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/app/outputs/flutter-apk/socute-${{ github.ref_name }}.apk"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          name: SoCute ${{ github.ref_name }}
          allowUpdates: true
          makeLatest: true
          removeArtifacts: true