name: Build fiau script
on:
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  merge-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch and Merge Scripts
        run: |
          # 1. Setup Environment
          BASE_URL="https://raw.githubusercontent.com/httptoolkit/frida-interception-and-unpinning/main"
          BUILD_DATE=$(date +"%B %d, %Y")
          OUTPUT_FILE="fiau-by-httptoolkit.js"
          mkdir -p temp_src

          # 2. Download Modules
          curl -s "$BASE_URL/config.js" -o temp_src/config.js
          curl -s "$BASE_URL/native-connect-hook.js" -o temp_src/native-connect-hook.js
          curl -s "$BASE_URL/native-tls-hook.js" -o temp_src/native-tls-hook.js
          curl -s "$BASE_URL/android/android-proxy-override.js" -o temp_src/android-proxy-override.js
          curl -s "$BASE_URL/android/android-system-certificate-injection.js" -o temp_src/android-system-certificate-injection.js
          curl -s "$BASE_URL/android/android-certificate-unpinning.js" -o temp_src/android-certificate-unpinning.js
          curl -s "$BASE_URL/android/android-certificate-unpinning-fallback.js" -o temp_src/android-certificate-unpinning-fallback.js
          curl -s "$BASE_URL/android/android-disable-flutter-certificate-pinning.js" -o temp_src/android-disable-flutter-certificate-pinning.js
          curl -s "$BASE_URL/android/android-disable-root-detection.js" -o temp_src/android-disable-root-detection.js

          # 3. Inject SOCUTE Placeholders using Perl
          perl -0777 -pi -e 's/const CERT_PEM = `.*?`;/const CERT_PEM = `{{SOCUTE_CERT_PEM}}`;/s' temp_src/config.js
          perl -pi -e "s/const PROXY_HOST = '.*?';/const PROXY_HOST = '{{SOCUTE_PROXY_HOST}}';/g" temp_src/config.js
          perl -pi -e "s/const PROXY_PORT = .*?;/const PROXY_PORT = {{SOCUTE_PROXY_PORT}};/g" temp_src/config.js
          perl -pi -e "s/const DEBUG_MODE = .*?;/const DEBUG_MODE = {{SOCUTE_DEBUG_MODE}};/g" temp_src/config.js
          perl -pi -e "s/const IGNORED_NON_HTTP_PORTS = .*?;/const IGNORED_NON_HTTP_PORTS = {{SOCUTE_IGNORED_PORTS}};/g" temp_src/config.js
          perl -pi -e "s/const BLOCK_HTTP3 = .*?;/const BLOCK_HTTP3 = {{SOCUTE_BLOCK_HTTP3}};/g" temp_src/config.js
          perl -pi -e "s/const PROXY_SUPPORTS_SOCKS5 = .*?;/const PROXY_SUPPORTS_SOCKS5 = {{SOCUTE_SOCKS5_SUPPORT}};/g" temp_src/config.js

          # 4. Create Header
          echo "/**************************************************************************************************" > $OUTPUT_FILE
          echo " * ðŸ›¡ï¸ SOCUTE.APK - Unified Android Interception Engine" >> $OUTPUT_FILE
          echo " * ------------------------------------------------------------------------------------------------" >> $OUTPUT_FILE
          echo " * Build Date : $BUILD_DATE" >> $OUTPUT_FILE
          echo " * Author     : Milio48 (socute.apk)" >> $OUTPUT_FILE
          echo " * Source     : https://github.com/httptoolkit/frida-interception-and-unpinning" >> $OUTPUT_FILE
          echo " * License    : AGPL-3.0-or-later" >> $OUTPUT_FILE
          echo " *" >> $OUTPUT_FILE
          echo " * [MERGE SEQUENCE]" >> $OUTPUT_FILE
          echo " * 1. config, 2. native-connect, 3. native-tls, 4. proxy-override," >> $OUTPUT_FILE
          echo " * 5. cert-injection, 6. unpinning, 7. fallback, 8. flutter, 9. anti-root" >> $OUTPUT_FILE
          echo " **************************************************************************************************/" >> $OUTPUT_FILE

          # 5. Concatenate Modules
          echo -e "\n/** [MODULE 1] Core Configuration & Utilities */" >> $OUTPUT_FILE
          cat temp_src/config.js >> $OUTPUT_FILE
          echo -e "\n/** [MODULE 2] Low-Level Socket Redirection */" >> $OUTPUT_FILE
          cat temp_src/native-connect-hook.js >> $OUTPUT_FILE
          echo -e "\n/** [MODULE 3] Native TLS Interceptor */" >> $OUTPUT_FILE
          cat temp_src/native-tls-hook.js >> $OUTPUT_FILE
          echo -e "\n/** [MODULE 4] Java Proxy Override */" >> $OUTPUT_FILE
          cat temp_src/android-proxy-override.js >> $OUTPUT_FILE
          echo -e "\n/** [MODULE 5] Dynamic Certificate Injection */" >> $OUTPUT_FILE
          cat temp_src/android-system-certificate-injection.js >> $OUTPUT_FILE
          echo -e "\n/** [MODULE 6] Universal Java Unpinning */" >> $OUTPUT_FILE
          cat temp_src/android-certificate-unpinning.js >> $OUTPUT_FILE
          echo -e "\n/** [MODULE 7] Java Unpinning Fallback */" >> $OUTPUT_FILE
          cat temp_src/android-certificate-unpinning-fallback.js >> $OUTPUT_FILE
          echo -e "\n/** [MODULE 8] Flutter Engine Bypass */" >> $OUTPUT_FILE
          cat temp_src/android-disable-flutter-certificate-pinning.js >> $OUTPUT_FILE
          echo -e "\n/** [MODULE 9] Anti-Detection & Stealth */" >> $OUTPUT_FILE
          cat temp_src/android-disable-root-detection.js >> $OUTPUT_FILE
          echo -e "\n// --- END OF ENGINE ---" >> $OUTPUT_FILE

      - name: Git Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add fiau-by-httptoolkit.js
          git commit -m "chore: update interception engine" || echo "No changes to commit"
          git push origin HEAD:main